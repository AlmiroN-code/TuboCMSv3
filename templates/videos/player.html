{% load core_tags %}
<div class="video-player-container">
    <div class="video-player">
        <video id="main-video" controls poster="{% if video.poster %}{{ video.poster.url }}{% endif %}">
            {% if video.converted_files %}
                {% for file_path in video.converted_files %}
                    {% with resolution=file_path|slice:"-7:-4" %}
                        <source src="/media/{{ file_path }}" type="video/mp4" data-quality="{{ resolution }}">
                    {% endwith %}
                {% endfor %}
            {% elif video.temp_video_file %}
                <source src="{{ video.temp_video_file.url }}" type="video/mp4" data-quality="primary">
            {% endif %}
            {% for video_file in video.available_qualities %}
                <source src="{{ video_file.file.url }}" type="video/mp4" data-quality="{{ video_file.profile.resolution }}">
            {% endfor %}
            Ваш браузер не поддерживает видео.
        </video>
        
        <div class="video-controls">
            <div class="quality-selector">
                <label for="quality-select">Качество:</label>
                <select id="quality-select">
                    {% if video.converted_files %}
                        {% for file_path in video.converted_files %}
                            {% with resolution=file_path|slice:"-7:-4" %}
                                <option value="{{ resolution }}" {% if forloop.first %}selected{% endif %}>
                                    {{ resolution }}p
                                </option>
                            {% endwith %}
                        {% endfor %}
                    {% elif video.temp_video_file %}
                        <option value="primary" selected>Основное качество</option>
                    {% endif %}
                    {% for video_file in video.available_qualities %}
                        <option value="{{ video_file.profile.resolution }}">
                            {{ video_file.profile.name }} ({{ video_file.profile.resolution }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="video-info">
                <span class="duration">{{ video.duration|format_duration }}</span>
                <span class="views">{{ video.views_count }} просмотров</span>
            </div>
        </div>
    </div>
</div>

<style>
.video-player-container {
    position: relative;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background: var(--bg-secondary);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.video-player {
    position: relative;
    width: 100%;
    background: #000;
}

.video-player video {
    width: 100%;
    height: auto;
    display: block;
}

.video-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
}

.quality-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quality-selector label {
    color: var(--text-primary);
    font-weight: 500;
    font-size: 14px;
}

.quality-selector select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.quality-selector select:hover {
    border-color: var(--accent-color);
}

.quality-selector select:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.2);
}

.video-info {
    display: flex;
    align-items: center;
    gap: 15px;
    color: var(--text-secondary);
    font-size: 14px;
}

.video-info .duration {
    font-weight: 500;
    color: var(--text-primary);
}

.video-info .views {
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .video-controls {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
    }
    
    .quality-selector {
        width: 100%;
        justify-content: center;
    }
    
    .video-info {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('main-video');
    const qualitySelect = document.getElementById('quality-select');
    const sources = video.querySelectorAll('source');
    
    // Store current time
    let currentTime = 0;
    
    qualitySelect.addEventListener('change', function() {
        const selectedQuality = this.value;
        const currentTime = video.currentTime;
        const isPaused = video.paused;
        
        // Find source with selected quality
        let selectedSource = null;
        sources.forEach(source => {
            if (source.dataset.quality === selectedQuality) {
                selectedSource = source;
            }
        });
        
        if (selectedSource) {
            // Update video source
            video.src = selectedSource.src;
            video.load();
            
            // Restore playback state
            video.addEventListener('loadeddata', function() {
                video.currentTime = currentTime;
                if (!isPaused) {
                    video.play();
                }
            }, { once: true });
        }
    });
    
    // Update quality selector when video source changes
    video.addEventListener('loadstart', function() {
        const currentSrc = video.currentSrc;
        sources.forEach(source => {
            if (source.src === currentSrc) {
                qualitySelect.value = source.dataset.quality;
            }
        });
    });
});
</script>
