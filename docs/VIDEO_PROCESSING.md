# Система обработки видео TubeCMS

## Обзор

TubeCMS включает полную систему обработки видео с конвертацией по профилям качества, извлечением метаданных и асинхронной обработкой через Celery.

## Архитектура

### Модели

1. **Video** - основная модель видео
   - `temp_video_file` - временный файл во время обработки
   - `preview` - короткое видео-превью
   - `poster` - постер (изображение)

2. **VideoFile** - сконвертированные файлы
   - Связь с профилем кодирования
   - Путь к файлу
   - Метаданные (размер, длительность)

3. **VideoEncodingProfile** - профили кодирования
   - Разрешение (360p, 720p, 1080p)
   - Параметры кодирования
   - Активность

4. **MetadataExtractionSettings** - настройки извлечения
   - Параметры постера
   - Параметры превью

## Процесс обработки

### 1. Загрузка видео

При загрузке видео через админку:

1. **Временное сохранение** - файл сохраняется в `/media/videos/tmp/`
2. **Выбор профилей** - администратор выбирает активные профили кодирования
3. **Асинхронная обработка** - Celery запускает задачу обработки

### 2. Обработка видео

Асинхронно выполняются следующие операции:

1. **Извлечение постера**
   - Кадр из середины видео
   - Размер: 250x150 (настраивается)
   - Формат: JPEG/PNG/WebP
   - Сохранение в `/media/posters/`

2. **Создание превью**
   - 12 секунд без звука
   - Составлено из фрагментов по 2 секунды
   - Размер: 250x150
   - Сохранение в `/media/previews/`

3. **Конвертация по профилям**
   - Кодирование в выбранные форматы
   - Сохранение в `/media/videos/{resolution}/`
   - Создание записей VideoFile

4. **Очистка**
   - Удаление временного файла
   - Обновление статуса обработки

## Админка

### Управление профилями кодирования

**URL:** `/admin/videos/videoencodingprofile/`

- Создание новых профилей
- Настройка параметров кодирования
- Активация/деактивация профилей

### Настройки извлечения метаданных

**URL:** `/admin/videos/metadataextractionsettings/`

- Параметры постера (размер, формат, качество)
- Параметры превью (длительность, сегменты, качество)

### Загрузка видео

**URL:** `/admin/videos/video/add/`

1. Заполните основную информацию
2. Загрузите видеофайл в поле "Temp video file"
3. Выберите профили кодирования в разделе "Кодирование"
4. Сохраните - обработка начнется автоматически

## Плеер

### Переключатель качества

На странице просмотра видео отображается:

- **HTML5 плеер** с поддержкой множественных источников
- **Переключатель качества** - выбор между доступными форматами
- **Сохранение времени** - при смене качества
- **Адаптивный дизайн** - для всех устройств

### Технические детали

- Использует `<source>` теги для разных качеств
- JavaScript для динамического переключения
- Сохранение времени воспроизведения при смене качества

## Структура файлов

```
/media/
├── videos/
│   ├── tmp/           # Временные файлы
│   ├── 360p/          # 360p версии
│   ├── 720p/          # 720p версии
│   └── 1080p/         # 1080p версии
├── posters/           # Постеры
└── previews/          # Видео-превью
```

## Настройка

### Профили кодирования по умолчанию

- **360p - Mobile** (640x360, 800 kbps)
- **720p - HD** (1280x720, 2500 kbps)  
- **1080p - Full HD** (1920x1080, 5000 kbps)

### Параметры извлечения по умолчанию

- **Постер:** 250x150, JPEG, качество 85%
- **Превью:** 250x150, 12 секунд, MP4, качество 85%

## Требования

### Системные зависимости

- **FFmpeg** - для обработки видео
- **Celery** - для асинхронных задач
- **Redis** - для очередей Celery

### Python пакеты

- `celery` - асинхронные задачи
- `redis` - кэширование и очереди
- `pillow` - обработка изображений

## Мониторинг

### Статусы обработки

- `pending` - ожидает обработки
- `processing` - в процессе
- `completed` - завершено
- `failed` - ошибка

### Логирование

Ошибки обработки сохраняются в поле `processing_error` модели Video.

## Производительность

### Оптимизации

- Асинхронная обработка через Celery
- Параллельная конвертация профилей
- Автоматическая очистка временных файлов
- Кэширование метаданных

### Масштабирование

- Горизонтальное масштабирование Celery workers
- Использование Redis Cluster
- CDN для статических файлов

## Безопасность

### Валидация файлов

- Проверка типа файла
- Ограничение размера
- Сканирование на вирусы (опционально)

### Доступ

- Авторизованные пользователи могут загружать видео
- Администраторы управляют профилями кодирования
- Публичный доступ только к обработанным файлам









